import{b as g,g as k}from"../chunks/auth-E5V3AkTb.js";chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"save-bookmark",title:"Save to LinkNest",contexts:["page","link"]})});chrome.contextMenus.onClicked.addListener(async(t,e)=>{if(t.menuItemId!=="save-bookmark")return;const o=t.linkUrl||t.pageUrl||(e==null?void 0:e.url),n=(e==null?void 0:e.title)||o;if(o)try{await chrome.storage.local.set({pendingBookmark:{url:o,title:n,timestamp:Date.now()}}),chrome.runtime.sendMessage({type:"QUICK_SAVE",payload:{url:o,title:n}}).catch(()=>{}),chrome.action.setBadgeText({text:"+1",tabId:e==null?void 0:e.id}),chrome.action.setBadgeBackgroundColor({color:"#e8590c",tabId:e==null?void 0:e.id}),setTimeout(()=>{chrome.action.setBadgeText({text:"",tabId:e==null?void 0:e.id})},2e3)}catch(r){console.error("Context menu save error:",r)}});chrome.runtime.onMessage.addListener((t,e,o)=>{if(t.type==="GET_CURRENT_TAB")return chrome.tabs.query({active:!0,currentWindow:!0},n=>{const r=n[0];o({url:(r==null?void 0:r.url)||"",title:(r==null?void 0:r.title)||"",favIconUrl:(r==null?void 0:r.favIconUrl)||""})}),!0;if(t.type==="CLEAR_PENDING")return chrome.storage.local.remove("pendingBookmark"),o({ok:!0}),!1;if(t.type==="SIGN_IN")return f(t.provider||"google").then(()=>o({ok:!0})).catch(n=>o({error:n.message||String(n)})),!0});async function f(t){const e=g(),o=chrome.identity.getRedirectURL();console.log("Extension redirect URL (add to Supabase):",o);const{data:n,error:r}=await e.auth.signInWithOAuth({provider:t,options:{redirectTo:o,skipBrowserRedirect:!0}});if(r||!(n!=null&&n.url))throw new Error((r==null?void 0:r.message)||"Failed to get OAuth URL");const u=await new Promise((m,d)=>{chrome.identity.launchWebAuthFlow({url:n.url,interactive:!0},l=>{chrome.runtime.lastError||!l?d(chrome.runtime.lastError||new Error("Auth cancelled")):m(l)})}),h=new URL(u),s=new URLSearchParams(h.hash.slice(1)),c=s.get("access_token"),i=s.get("refresh_token");if(!c||!i)throw new Error("No tokens found in redirect URL");const{error:a}=await e.auth.setSession({access_token:c,refresh_token:i});if(a)throw a}chrome.alarms.create("refresh-session",{periodInMinutes:30});chrome.alarms.onAlarm.addListener(async t=>{if(t.name==="refresh-session")try{await k()}catch{}});
